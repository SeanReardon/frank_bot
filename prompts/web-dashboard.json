{
  "id": "web-dashboard",
  "title": "Frank Bot Web Dashboard with Telegram Setup",
  "description": "Web dashboard for frank_bot focusing on Telegram integration and meta scripts monitoring",
  "authors": [
    { "name": "Sean", "type": "human" },
    { "name": "Claude", "type": "model" }
  ],
  "createdAt": "2026-01-28T22:00:00Z",
  "status": "ready",
  "tags": ["web", "dashboard", "telegram", "infrastructure"],
  "content": "# Frank Bot Web Dashboard\n\nBuild a web dashboard for frank_bot at `frank-bot.contrived.com`, following the same patterns as `claudia/web` and `capital-game/web`. This dashboard provides Telegram setup/monitoring and meta scripts visibility.\n\n## Architecture\n\nCreate a `./web` folder in frank_bot with:\n- Vite + TypeScript + Lit Web Components (matching claudia/web pattern)\n- nginx.conf for routing (proxying `/api/*` to `frank-bot:8000`)\n- Dockerfile for containerized deployment (multi-stage: Node builder → Nginx server)\n- Authentication via Stytch SSO (domain-scoped cookie from contrived.com)\n\nThe web container (`frank-bot-web`) is already added to docker-compose.yml and shares the `./data` volume with the API container.\n\n## Tech Stack\n\nFollow the patterns in `~/dev/claudia/web/`:\n- **Lit 3.x** for Web Components with decorators\n- **Vite 5.x** with TypeScript, dual build (library + dev)\n- **CSS custom properties** for theming (inherits from contrived-site)\n- **No React** - use Lit's html template literal\n\n## Authentication\n\nStytch SSO via domain-scoped cookie (same as claudia/capital-game):\n- Cookie `stytch_session_token` is set on `.contrived.com` domain\n- Dashboard reads cookie directly (subdomain app pattern)\n- Include `activity-tracker-lite.js` for session keepalive\n- No client-side Stytch SDK needed\n\nReference `~/dev/contrived-site/` for the SSO flow details.\n\n## Backend Additions Required\n\nNew endpoints in frank_bot API (add to `server/routes.py` and `actions/telegram.py`):\n\n### Telegram Auth Flow\n\n1. `GET /telegram/status`\n   - Returns: `{ status: 'not_configured' | 'needs_auth' | 'connected', account?: { name, username, phone } }`\n   - Checks: env vars present → session file exists → session authorized\n\n2. `POST /telegram/auth/start`\n   - Body: `{ phone?: string }` (optional, uses env var if not provided)\n   - Returns: `{ status: 'code_sent' | 'already_authorized' | 'error', phoneCodeHash?: string }`\n   - Sends verification code to Telegram app\n\n3. `POST /telegram/auth/verify`\n   - Body: `{ code: string, phoneCodeHash: string }`\n   - Returns: `{ status: 'success' | 'invalid_code' | 'needs_2fa' | 'error' }`\n\n4. `POST /telegram/auth/2fa`\n   - Body: `{ password: string }`\n   - Returns: `{ status: 'success' | 'invalid_password' | 'error' }`\n\n5. `GET /telegram/test`\n   - Returns: `{ connected: boolean, dialogs?: [first 3 chats], error?: string }`\n\n### Protect Auth Endpoints\n\nThese endpoints should require Stytch authentication. Add middleware to validate the `stytch_session_token` cookie for `/telegram/auth/*` routes.\n\n## Frontend Components\n\n### Main Dashboard (`frank-bot-dashboard.ts`)\n\nEntry point component accepting props:\n- `session-token` - Stytch session token (optional, can read from cookie)\n- `api-base` - API base URL (default: `/api`)\n\n### Telegram Card (`telegram-card.ts`)\n\nDisplays Telegram connection status and setup wizard:\n\n**States:**\n1. `not_configured` - Show message about missing env vars\n2. `needs_auth` - Show setup wizard (code entry form)\n3. `connected` - Show account info + test button + disconnect option\n\n**Setup Wizard Flow:**\n1. Click \"Connect Telegram\" → calls `/telegram/auth/start`\n2. Enter verification code → calls `/telegram/auth/verify`\n3. If 2FA required → show password field → calls `/telegram/auth/2fa`\n4. Success → show connected state\n\n### Scripts Card (`scripts-card.ts`)\n\nList meta scripts with stats:\n- Fetch from `GET /frank/scripts`\n- Show: name, description, execution count, last run time\n- Click to view script details/code\n\n### Jobs Card (`jobs-card.ts`)\n\nRecent job executions:\n- Fetch from `GET /frank/jobs`\n- Show: script name, status (pending/running/completed/failed), started_at, duration\n- Filter by status\n- Click to view job details (stdout, stderr, result)\n\n## File Structure\n\n```\nweb/\n├── src/\n│   ├── frank-bot-dashboard.ts    # Main entry component\n│   ├── components/\n│   │   ├── telegram-card.ts      # Telegram status + setup wizard\n│   │   ├── scripts-card.ts       # Meta scripts list\n│   │   └── jobs-card.ts          # Job executions\n│   ├── lib/\n│   │   └── api.ts                # API client (configurable base, auth header)\n│   └── styles/\n│       └── tokens.css            # CSS custom property fallbacks for dev\n├── index.html                    # Dev preview page\n├── vite.config.ts\n├── tsconfig.json\n├── package.json\n├── nginx.conf\n└── Dockerfile\n```\n\n## nginx.conf\n\nKey routing:\n- `/api/*` → proxy to `http://frank-bot:8000/*` (strip `/api` prefix)\n- `/health` → return 200 (for container health check)\n- `/*` → serve static files with SPA fallback\n- CORS headers for embedding from contrived.com\n\n## Data Persistence\n\nTelegram session file location:\n- Container path: `/app/data/frank_bot.session`\n- Host path: `/home/frank_bot/data/frank_bot.session`\n- Shared between API and web containers via `./data:/app/data` mount\n\nUpdate `services/telegram_client.py` to use `DATA_DIR` env var for session file location:\n```python\nself._session_name = os.path.join(\n    os.getenv('DATA_DIR', '.'),\n    settings.telegram_session_name\n)\n```\n\n## Deployment\n\nThe docker-compose.yml already includes `frank-bot-web` service. The homelab-infra update script pulls both images.\n\nCI/CD (add to `.github/workflows/build_and_push.yml`):\n- Build `./web` Dockerfile\n- Push to `ghcr.io/seanreardon/frank_bot-web:latest`\n\n## Reference\n\nKey files to examine for patterns:\n- `~/dev/claudia/web/src/claudia-dashboard-embed.ts` - Component structure\n- `~/dev/claudia/web/src/api.ts` - API client pattern\n- `~/dev/claudia/web/nginx.conf` - Nginx proxy config\n- `~/dev/claudia/web/Dockerfile` - Multi-stage build\n- `~/dev/claudia/web/vite.config.ts` - Vite dual-build setup\n- `~/dev/capital-game/web/src/capital-game.ts` - Auth integration\n- `~/dev/contrived-site/src/routes/api/session-token.ts` - Session token endpoint\n\n## Out of Scope (Future)\n\n- Jorbs dashboard (separate prompt)\n- Activity log / message history\n- Configuration editing\n- Environment switching (test/prod Telegram servers)"
}
