{
  "id": "fix-system-status-panel-refresh-jank",
  "title": "Fix System Status Panel Refresh Layout Jank",
  "description": "Keep diagnostics panel stable during polling refresh using stale-while-revalidate pattern instead of replacing content with spinner",
  "authors": [
    {
      "name": "User",
      "type": "human"
    },
    {
      "name": "Claude",
      "type": "model"
    }
  ],
  "createdAt": "2026-02-17T12:00:00Z",
  "status": "ready",
  "tags": [
    "web",
    "ux",
    "lit",
    "polling"
  ],
  "content": "# Fix System Status Panel Refresh Layout Jank\n\n## Problem\n\nIn `frank_bot-web`, the top diagnostics/system status panel (`<system-status-card>`) refreshes via polling every 60 seconds. On each refresh, the entire panel body is replaced with a full spinner/loading state, causing the page to jump/jank as the content collapses and re-expands.\n\n## Root Cause\n\nIn `web/src/components/system-status-card.ts`:\n\n1. `_fetchStatus()` sets `this._loading = true` on **every** fetch (both initial and polling refreshes).\n2. `_renderContent()` checks `if (this._loading)` and replaces the entire panel body with a spinner + \"Loading system status...\" text.\n3. This unmounts all status rows, collapses the card height, shows a spinner, then re-renders everything when data arrives \u2014 causing visible layout jank every 60s.\n\n## Required Fix (Stale-While-Revalidate Pattern)\n\nApply 3 minimal edits to `web/src/components/system-status-card.ts`:\n\n### Edit 1: Add `_refreshing` state property\n\nAdd a new `@state()` property alongside the existing `_loading`:\n\n```ts\n@state() private _refreshing = false;\n```\n\n### Edit 2: Bifurcate `_fetchStatus()` \u2014 initial load vs. background refresh\n\nReplace the `_fetchStatus()` method so that:\n- **First load** (`_status` is null and `_error` is null): sets `_loading = true` \u2192 full spinner is appropriate since there's nothing to display yet.\n- **Subsequent polls** (`_status` already has data): sets `_refreshing = true` instead \u2192 existing content stays rendered untouched, data swaps in-place when fetch resolves.\n- Move `_error = null` into the try-success path so stale errors aren't cleared before the fetch completes.\n- On fetch error when stale data exists: swallow the error silently, keep the panel showing last-known-good data (no layout collapse).\n\nNew implementation:\n```ts\nprivate async _fetchStatus() {\n  const isInitial = this._status === null && this._error === null;\n  if (isInitial) {\n    this._loading = true;\n  } else {\n    this._refreshing = true;\n  }\n\n  try {\n    this._status = await api.getSystemStatus();\n    this._error = null;\n  } catch (err) {\n    if (!this._status) {\n      this._error = err instanceof Error ? err.message : 'Failed to fetch system status';\n    }\n    // If stale data exists, keep it rendered \u2014 don't flash an error\n  } finally {\n    this._loading = false;\n    this._refreshing = false;\n  }\n}\n```\n\n### Edit 3: Add tiny inline refresh indicator in `render()` header\n\nIn the `render()` method's card header, add a barely-visible refresh indicator (35% opacity, 0.7em `\u21bb` character) next to \"System Status\" when `_refreshing` is true. This should be extremely subtle \u2014 99.99% invisible during normal use. Also disable the manual refresh button during refresh.\n\nAdd after the \"System Status\" text in the header:\n```ts\n${this._refreshing ? html`<span style=\"margin-left:8px;opacity:0.35;font-size:0.7em;font-weight:400\">\u21bb</span>` : nothing}\n```\n\nUpdate the refresh button's disabled binding:\n```ts\n?disabled=${this._loading || this._refreshing}\n```\n\nThe `nothing` import from Lit should already be available (check existing imports).\n\n### No changes needed to `_renderContent()`\n\nThe existing `_renderContent()` method gates on `this._loading` (now only true on initial load) and renders from `this._status` (stays populated during polls). It works correctly with the new approach.\n\n## Files to Modify\n\n| File | Changes |\n|---|---|\n| `web/src/components/system-status-card.ts` | Add `_refreshing` state; rewrite `_fetchStatus()` to bifurcate initial vs refresh; add inline indicator + disable button in `render()` |\n\n## Constraints\n\n- **One file only**, ~20 lines changed\n- No new dependencies\n- No structural/architectural changes\n- No changes to the API layer or polling interval\n- Reuse existing CSS classes and Lit imports\n- The inline indicator must be extremely subtle (low opacity, small font) \u2014 should not distract during normal use",
  "executions": [
    {
      "executedAt": "2026-02-17T04:59:51.322956Z",
      "model": "claude:opus",
      "prdIds": [
        "frank_bot-00135"
      ],
      "tokensUsed": 2484
    }
  ]
}
