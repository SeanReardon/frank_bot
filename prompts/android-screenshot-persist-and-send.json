{
  "id": "android-screenshot-persist-and-send",
  "title": "Persist Android Screenshots & Send via Telegram",
  "description": "Persist final screenshots from android.task_do runs, add TelegramClient.send_photo(), and wire screenshot delivery to Sean",
  "authors": [
    {
      "name": "Sean Reardon",
      "type": "human"
    },
    {
      "name": "Claude",
      "type": "model"
    }
  ],
  "createdAt": "2026-02-17T18:00:00Z",
  "status": "ready",
  "tags": [
    "android",
    "screenshot",
    "telegram",
    "task-pipeline"
  ],
  "content": "# Persist Android Screenshots & Send via Telegram\n\n## Context\n\nScreenshot capture is already fully implemented in frank_bot:\n- `services/android_client.py` \u2014 `take_screenshot()` captures via `adb shell screencap -p`\n- `actions/android_phone.py` \u2014 `get_screen_action()` encodes to base64, parses UI XML\n- `services/android_phone_runner.py` \u2014 `RunResult` has `final_screenshot_base64: str | None`\n- The LLM vision loop already receives base64 screenshots at each step\n\n**The gap**: `_execute_task_background()` in `services/android_phone_runner.py` drops `RunResult.final_screenshot_base64` when writing results to storage. Screenshots are captured and used during the run but never persisted or forwarded after completion.\n\n## Goal\n\nThree incremental changes:\n1. Persist the final screenshot from each `task_do` run to disk and store the path in task results\n2. Add `TelegramClient.send_photo()` so frank_bot can send images via Telegram\n3. Wire screenshot delivery so task completions can notify Sean with the final screenshot\n\n## PR 1: Persist Final Screenshot from Task Runs\n\n### Changes\n\n**`services/android_phone_runner.py`** \u2014 In `_execute_task_background()` (around line 1372-1384), after the run completes:\n- Decode `result.final_screenshot_base64` and write it to `./data/screenshots/{task_id}.png`\n- Create the `./data/screenshots/` directory if it doesn't exist\n- Include `final_screenshot_path` in the result dict written to task storage\n\n**`actions/android_phone.py`** \u2014 In `task_get_action()`, include the `final_screenshot_path` in the response. Optionally support a `include_screenshot_base64` parameter that reads the file and returns inline base64.\n\n### Storage approach\n- Store PNGs on disk at `./data/screenshots/{task_id}.png` (not base64 in the DB \u2014 too large)\n- Return file paths in API responses by default\n- No presigned URLs needed \u2014 bot and Telegram client are co-located on the same host\n\n### Tests\n- Extend tests in `tests/test_android_phone_actions.py` for `task_do`/`task_get` to assert:\n  - Screenshot file is written to disk when `final_screenshot_base64` is present\n  - `task_get` response includes `final_screenshot_path`\n  - Missing screenshot (None) is handled gracefully\n- Mock `RunResult.final_screenshot_base64` with a small test PNG (1x1 pixel)\n\n### Security\n- Sanitize `task_id` before using in file paths to prevent path traversal\n- Set file permissions to `0o600` on written screenshots\n- `./data/screenshots/` must not be web-accessible\n\n## PR 2: Add TelegramClient.send_photo()\n\n### Changes\n\n**`services/telegram_client.py`** \u2014 Add a new method:\n\n```python\nasync def send_photo(\n    self,\n    recipient: str,\n    photo_path: str,\n    caption: str | None = None,\n) -> TelegramMessageResult:\n```\n\n- Use Telethon's `client.send_file(recipient, photo_path, caption=caption)`\n- Telethon auto-detects image type and renders as a photo (not document) in Telegram\n- Mirror the error handling from `send_message()` (FloodWaitError, UserNotMutualContactError, etc.)\n\n**`actions/telegram_bot.py`** (or equivalent) \u2014 Add `telegram_send_photo_action(recipient, photo_path, caption)` action endpoint.\n\n### Path validation\n- Validate `photo_path` is within allowed directories (`./data/screenshots/`, `/tmp/android_screenshot_*`)\n- Reject paths outside the allowlist to prevent arbitrary file exfiltration\n\n### Tests\n- Mock `client.send_file()` in tests\n- Verify FloodWaitError handling\n- Verify caption passthrough\n- Verify path validation rejects `../../etc/passwd` style paths\n\n## PR 3: Wire Screenshot Delivery into Task Pipeline\n\n### Changes\n\n- In `_execute_task_background()`, after persisting the screenshot, optionally send it to Sean via `TelegramClient.send_photo()`\n- Add a `notify_screenshot: bool = False` parameter to `task_do_action()` that triggers auto-send on completion\n- Caption should include the task description and completion status\n- Alternatively (or additionally), expose as a FrankAPI capability `frank.telegram.send_photo(recipient, path, caption)` so jorb scripts can send screenshots programmatically\n\n### Tests\n- Integration test mocking both the android runner and telegram client\n- Verify photo is sent when `notify_screenshot=true`\n- Verify photo is NOT sent when `notify_screenshot=false` (default)\n\n## PR 4 (Optional): Per-Step Screenshot Archive\n\n- Store intermediate `StepResult` screenshots as `./data/screenshots/{task_id}_step_{n}.png`\n- Useful for debugging failed automations\n- Expose via `task_get` with `?include_steps=true`\n- Implement TTL-based cleanup (delete screenshots older than 24h), following the pattern from `android_audit.py` 30-day log rotation\n\n## Security & Privacy Considerations\n\n1. **Sensitive content**: Screenshots may contain messages, banking apps, personal data \u2014 store with restricted permissions (`0o600`), non-web-accessible directory\n2. **Auto-deletion**: TTL-based cleanup (24h default) to limit exposure window\n3. **Path traversal**: All file-path APIs must validate paths are within the screenshots directory\n4. **Telegram recipient allowlist**: `send_photo()` should restrict recipients to Sean's username to prevent exfiltration\n5. **Logging**: Don't log full base64 screenshot data \u2014 log metadata only (size, hash, path)\n6. **Rate limiting**: Add rate limits to screenshot endpoints to prevent disk exhaustion\n\n## Files to Modify\n\n| File | Changes |\n|---|---|\n| `services/android_phone_runner.py` | Persist `final_screenshot_base64` to disk in `_execute_task_background()` |\n| `actions/android_phone.py` | Return `final_screenshot_path` in `task_get_action()` |\n| `services/telegram_client.py` | Add `send_photo()` method |\n| `actions/telegram_bot.py` | Add `telegram_send_photo_action()` |\n| `tests/test_android_phone_actions.py` | Screenshot persistence tests |\n| `tests/test_telegram_client.py` | send_photo tests |\n\n## Implementation Order\n\n1. PR 1 first \u2014 foundation (persist screenshots)\n2. PR 2 next \u2014 capability (send photos via Telegram)\n3. PR 3 \u2014 integration (wire them together)\n4. PR 4 \u2014 optional enhancement (step-level screenshots)\n",
  "executions": [
    {
      "executedAt": "2026-02-17T08:10:31.296079Z",
      "model": "claude:opus",
      "prdIds": [
        "frank_bot-00136",
        "frank_bot-00137",
        "frank_bot-00138",
        "frank_bot-00139",
        "frank_bot-00140"
      ],
      "tokensUsed": 3392
    }
  ]
}
