{
  "$schema": "https://claudia.contrived.com/schemas/prompt.schema.json",
  "id": "telegram-integration",
  "title": "Telegram Integration for Frank Bot",
  "description": "Add Telegram messaging via Telethon for interacting with bots and services",
  "authors": [
    {
      "name": "Sean",
      "type": "human"
    },
    {
      "name": "Claude",
      "type": "model"
    }
  ],
  "createdAt": "2026-01-29T00:00:00Z",
  "status": "ready",
  "tags": [
    "telegram",
    "messaging",
    "telethon",
    "integration"
  ],
  "content": "# Telegram Integration for Frank Bot\n\n## Overview\n\nAdd Telegram messaging capabilities to frank_bot using Telethon (MTProto client library). This enables frank_bot to send and receive messages through Sean's personal Telegram account, interacting with bots and services on his behalf.\n\n## Why Telethon (not Bot API)\n\nThe Telegram Bot API only allows bots to respond to users who message them first. For our use case - interacting with company bots, Magic concierge, etc. - we need to use a user account. Telethon provides this via Telegram's MTProto protocol.\n\n## Architecture\n\n```\nfrank_bot/\n\u251c\u2500\u2500 services/\n\u2502   \u2514\u2500\u2500 telegram_client.py    # Telethon wrapper (NEW)\n\u251c\u2500\u2500 actions/\n\u2502   \u2514\u2500\u2500 telegram.py           # Action handlers (NEW)\n\u2514\u2500\u2500 server/\n    \u2514\u2500\u2500 routes.py             # Add /telegram/* endpoints (MODIFY)\n```\n\n## Service: telegram_client.py\n\nCreate a TelegramClientService class that:\n\n1. **Initializes Telethon client** with API credentials from environment\n2. **Maintains persistent session** (session file stored locally)\n3. **Handles authentication** - first run requires phone number + code\n4. **Provides async methods**:\n   - `send_message(recipient, text)` - send to user/bot by username or phone\n   - `get_messages(chat_id, limit)` - retrieve recent messages from a chat\n   - `get_dialogs(limit)` - list recent conversations\n   - `mark_read(chat_id)` - mark messages as read\n5. **Event handler registration** - ability to register callbacks for incoming messages\n\n## Actions: telegram.py\n\nImplement action handlers following frank_bot's existing pattern:\n\n```python\nasync def send_telegram_message(arguments: dict[str, Any] | None = None) -> dict[str, Any]:\n    \"\"\"Send a message via Telegram.\"\"\"\n    # recipient: username (@Magic) or phone number\n    # text: message content\n    \nasync def get_telegram_messages(arguments: dict[str, Any] | None = None) -> dict[str, Any]:\n    \"\"\"Get recent messages from a Telegram chat.\"\"\"\n    # chat: username or chat_id\n    # limit: number of messages (default 10)\n    \nasync def list_telegram_chats(arguments: dict[str, Any] | None = None) -> dict[str, Any]:\n    \"\"\"List recent Telegram conversations.\"\"\"\n    # limit: number of chats (default 20)\n```\n\n## Routes\n\nAdd to server/routes.py:\n- `GET /telegram/send` - Send a message\n- `GET /telegram/messages` - Get messages from a chat  \n- `GET /telegram/chats` - List recent chats\n\nFollow existing routing patterns (GET methods, query parameters, _build_responder wrapper).\n\n## OpenAPI Spec\n\nUpdate openapi/spec.json with the new endpoints. Follow existing spec patterns.\n\n## Environment Variables\n\nAdd to .env.example:\n\n```bash\n# Telegram (from my.telegram.org)\nTELEGRAM_API_ID=your_api_id\nTELEGRAM_API_HASH=your_api_hash\nTELEGRAM_PHONE=+1234567890\nTELEGRAM_SESSION_NAME=frank_bot\n```\n\n## Session Management\n\nTelethon creates a `.session` file for authentication state. This should:\n- Be stored in a configurable location (default: project root)\n- Be gitignored (contains auth tokens)\n- Persist across restarts\n\nFirst-time authentication flow:\n1. Client starts, no session file exists\n2. Telethon prompts for phone number\n3. Telegram sends verification code (SMS or app)\n4. Code entered, session file created\n5. Subsequent starts use session file automatically\n\nFor frank_bot running in Docker/server context, we may need a one-time interactive setup script (similar to setup_google_credentials.py).\n\n## Error Handling\n\n- Handle disconnections gracefully (auto-reconnect)\n- Rate limiting (Telegram has flood limits)\n- Session invalidation (re-auth needed)\n- Recipient not found errors\n\n## Testing Considerations\n\n- Mock Telethon client for unit tests\n- Integration tests require real credentials (skip in CI)\n- Test sending to self (Sean's account to Sean's account)\n\n## Dependencies\n\nAdd to pyproject.toml:\n```\ntelethon = \"^1.34\"  # or latest stable\n```\n\n## Success Criteria\n\n1. Can send a message to a Telegram user/bot via frank_bot API\n2. Can retrieve message history from a Telegram chat\n3. Can list recent Telegram conversations\n4. Session persists across frank_bot restarts\n5. Errors are handled gracefully with meaningful responses\n6. OpenAPI spec documents new endpoints\n7. Works alongside existing frank_bot services (calendar, SMS, etc.)\n\n## Reference\n\n- Telethon docs: https://docs.telethon.dev/\n- Existing frank_bot service pattern: services/telnyx_sms.py\n- Existing action pattern: actions/sms.py",
  "executions": [
    {
      "executedAt": "2026-01-29T04:07:46.361498Z",
      "model": "claude-opus",
      "prdIds": [
        "frank_bot-00014",
        "frank_bot-00015",
        "frank_bot-00016",
        "frank_bot-00017",
        "frank_bot-00018",
        "frank_bot-00019",
        "frank_bot-00020",
        "frank_bot-00021"
      ],
      "tokensUsed": 2943
    }
  ]
}
