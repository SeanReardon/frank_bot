# Claudia Progress Log

This file tracks completed work by the Claudia autonomous agent.
Each entry documents what was implemented and lessons learned.

---

## 2026-01-29: frank_bot-00001 - Create meta module structure and FrankAPI namespace classes

### Summary
Created the meta/ module with FrankAPI class providing synchronous namespace-based access to Frank Bot actions. All six namespaces (calendar, contacts, sms, swarm, ups, time) are implemented with stub methods that will wrap the existing async actions using asyncio.run().

### Files Changed
- meta/__init__.py
- meta/api.py
- meta/executor.py
- meta/introspection.py

### Learnings
- The existing action handlers follow a consistent pattern: `async def action_name(arguments: dict[str, Any] | None = None) -> dict[str, Any]`
- Each action accepts an arguments dict and returns a dict with `message` and domain-specific data
- The namespace methods mirror the action parameters but use explicit keyword arguments for better IDE support
- executor.py and introspection.py are placeholder files for future tasks (frank_bot-00006 and frank_bot-00007)

---

## 2026-01-29: frank_bot-00002 - Implement CalendarNamespace with sync wrappers for existing calendar actions

### Summary
Added comprehensive unit tests for CalendarNamespace that verify the namespace methods correctly wrap the underlying async calendar action handlers. The tests mock the action layer to avoid requiring actual API credentials while verifying parameter passing and return value handling.

### Files Changed
- tests/test_calendar_namespace.py (new)

### Learnings
- The CalendarNamespace was already implemented correctly in task frank_bot-00001 - the "stub methods" mentioned in that task were actually full implementations using asyncio.run()
- Unit tests should mock at the action layer (`actions.calendar.get_events_action`) rather than at the meta.api layer since the imports happen inside the methods
- Tests verify: parameter passing for all method signatures, default values, return value passthrough, and FrankAPI integration

---

## 2026-01-29: frank_bot-00003 - Implement remaining namespace classes (contacts, sms, swarm, ups, time)

### Summary
Added comprehensive unit tests for all remaining namespace classes: ContactsNamespace, SMSNamespace, SwarmNamespace, UPSNamespace, and TimeNamespace. All namespace implementations were already complete in meta/api.py from task frank_bot-00001, so this task focused on creating tests to verify the wrappers work correctly.

### Files Changed
- tests/test_contacts_namespace.py (new)
- tests/test_sms_namespace.py (new)
- tests/test_swarm_namespace.py (new)
- tests/test_ups_namespace.py (new)
- tests/test_time_namespace.py (new)

### Learnings
- All namespace classes were already fully implemented in task 00001, not just stubs
- SwarmNamespace.checkins() has the most parameters (11) including: year, after_date, before_date, category, with_companion, companion_match, only_with_companions, has_photos, include_photos, max_results, stale_minutes
- TimeNamespace.now() accepts a timezone parameter for future compatibility, but the underlying action doesn't currently use it
- UPSNamespace.status() takes no parameters and returns runtime, charge_percent, and temperature_f
- SMSNamespace.send() requires both recipient (name or phone) and message as positional arguments
- ContactsNamespace.search() requires query as a positional argument with optional max_results
- Tests follow the same mocking pattern as CalendarNamespace: mock at the action layer since imports happen inside the methods

---

## 2026-01-29: frank_bot-00004 - Implement script storage and parsing utilities

### Summary
Implemented script storage and parsing utilities in meta/scripts.py. Scripts are stored as .py files with timestamped filenames, and docstrings are parsed to extract metadata (description, parameters, example). Created comprehensive unit tests covering docstring parsing, filename handling, and CRUD operations.

### Files Changed
- meta/scripts.py (new)
- tests/test_scripts.py (new)

### Learnings
- Script filenames use filesystem-safe ISO 8601 format: YYYY-MM-DDTHH-MM-SSZ (colons replaced with dashes)
- Python's ast module is reliable for extracting module docstrings even without executing the code
- Docstring parsing needs to handle both "Parameters:" and "Args:" section headers
- ScriptMetadata dataclass provides clean abstraction for script information

---

## 2026-01-29: frank_bot-00005 - Implement job storage and management

### Summary
Implemented job storage and management in meta/jobs.py. Jobs track script executions with status (pending, running, completed, failed, timeout), capturing params, stdout, stderr, result, and error. Created comprehensive unit tests for all CRUD operations.

### Files Changed
- meta/jobs.py (new)
- tests/test_jobs.py (new)

### Learnings
- JobStatus enum extends str for JSON serialization compatibility
- Job filenames use pattern {timestamp}-{slug}-run.json to distinguish from scripts
- Auto-setting completed_at for terminal statuses (completed, failed, timeout) simplifies update logic
- Jobs are sorted by started_at descending for newest-first listing

---

## 2026-01-29: frank_bot-00007 - Implement introspection module for meta documentation generation

### Summary
Implemented the introspection module in meta/introspection.py that generates Markdown documentation from FrankAPI by inspecting namespace classes. Documentation includes quick start example, execution workflow, method tables for all services, and usage notes.

### Files Changed
- meta/introspection.py (updated from placeholder)
- tests/test_introspection.py (new)

### Learnings
- Python's inspect module combined with get_type_hints() reliably extracts method signatures
- Pipe characters in Markdown tables need escaping for valid output
- Documentation structure should match API discovery workflow: quick start -> execution -> services -> notes
- Code fence counts must balance (```python + ```json = ``` closers)

---

## 2026-01-29: frank_bot-00013 - Ensure data volume is mounted in Docker configuration

### Summary
Updated docker-compose.yml to mount ./data:/app/data volume for persisting scripts and jobs. Added DATA_DIR environment variable for container path configuration. Updated README with data directory documentation.

### Files Changed
- docker-compose.yml
- README.md
- meta/scripts.py (updated DEFAULT_SCRIPTS_DIR to use DATA_DIR env var)
- meta/jobs.py (updated DEFAULT_JOBS_DIR to use DATA_DIR env var)

### Learnings
- Using environment variable (DATA_DIR) with fallback to relative path allows same code to work in both Docker and local development
- Docker volume mount ./data:/app/data provides persistence across container restarts
- README project structure should document the data/ directory for discoverability

---

## 2026-01-29: frank_bot-00006 - Implement script executor with timeout and output capture

### Summary
Implemented the script executor in meta/executor.py that executes scripts' main() functions with FrankAPI injection, parameter passing, stdout/stderr capture, timeout handling (10 minutes default), and error capture. Supports both synchronous execution and async execution with job tracking.

### Files Changed
- meta/executor.py (fully implemented)
- tests/test_executor.py (new - 20 tests)

### Learnings
- ThreadPoolExecutor with future.result(timeout=) provides clean timeout handling
- StringIO captures stdout/stderr when sys.stdout/stderr are temporarily replaced
- exec() with a global namespace allows defining main() and then calling it
- Background execution with threading.Thread(daemon=True) allows non-blocking job execution
- Scripts must accept **kwargs to handle arbitrary parameters passed from execute endpoint

---

## 2026-01-29: frank_bot-00008 - Add GET /frank/meta and GET /frank/scripts endpoints

### Summary
Implemented server routes for /frank/meta (returns Markdown API documentation), /frank/scripts (lists all saved scripts with metadata), and /frank/scripts/{id} (returns script source code). Routes follow existing patterns and are protected by API key auth.

### Files Changed
- server/meta_routes.py (new)
- server/app.py (updated to include meta routes)
- tests/test_meta_routes.py (new - 19 integration tests)

### Learnings
- Starlette's HTTPException doesn't automatically return JSON in all cases; returning JSONResponse directly is more reliable
- Route patterns like {script_id:path} allow IDs containing slashes if needed
- API key auth check returns response or None pattern avoids exception handling complexity

---

## 2026-01-29: frank_bot-00009 - Add POST /frank/execute endpoint

### Summary
Implemented POST /frank/execute endpoint that accepts either script_id (for existing scripts) or slug+code (for new scripts) with optional params. Creates a job record, starts background execution, and returns immediately with job_id and status='running'.

### Files Changed
- server/meta_routes.py (execute_handler added)
- tests/test_meta_routes.py (TestExecute class - 4 tests)

### Learnings
- Request body parsing should return error response directly rather than raising exceptions
- The execute endpoint serves two use cases: run existing scripts by ID, or save+run new scripts
- Background thread execution allows immediate response while job runs

---

## 2026-01-29: frank_bot-00010 - Add GET /frank/jobs endpoints

### Summary
Implemented GET /frank/jobs (lists all jobs with optional status filter) and GET /frank/jobs/{id} (returns full job details including stdout, stderr, result, error). Endpoints follow existing patterns and support status filtering.

### Files Changed
- server/meta_routes.py (list_jobs_handler, get_job_handler added)
- tests/test_meta_routes.py (TestListJobs, TestGetJob classes - 7 tests)

### Learnings
- Optional query parameters for filtering (status) provide flexibility without complicating required paths
- Job summary vs details distinction keeps list responses lightweight while detail endpoint provides full data
- Polling pattern: POST /execute returns job_id, then GET /jobs/{id} to check completion

---

## 2026-01-29: frank_bot-00011 - Update OpenAPI spec with new meta endpoints

### Summary
Updated openapi/spec.json with all new /frank/* endpoints including paths, parameters, request/response schemas. Added schemas for ScriptMetadata, ExecuteScriptRequest, ExecuteScriptResponse, JobSummary, JobDetails, etc.

### Files Changed
- openapi/spec.json (7 new paths, 9 new schemas)

### Learnings
- OpenAPI 3.1 supports text/markdown and text/x-python content types for non-JSON responses
- "oneOf" could model the execute request (script_id OR slug+code) but plain description is clearer
- Spec passes linting with existing warnings (no new issues introduced)

---

## 2026-01-29: frank_bot-00012 - Update instructions_for_chatgpt.txt with script execution guidance

### Summary
Added comprehensive script execution guidance to instructions_for_chatgpt.txt, including when to use the execute endpoint (pagination, filtering, aggregation, combining data sources), the full workflow (meta -> scripts -> execute -> jobs -> present), a complete hotels-in-SF example, API reference table, and tips for effective script usage.

### Files Changed
- instructions_for_chatgpt.txt

### Learnings
- The instructions file serves as the primary documentation for ChatGPT/AI assistants using the API
- Clear workflow documentation (numbered steps) helps AI assistants understand the polling pattern
- Concrete examples (hotels in SF) are more valuable than abstract descriptions
- Emphasizing "for getting data, not presenting it" is important since AI assistants might try to embed formatting logic in scripts

---

## 2026-01-29: frank_bot-00014 - Add Telethon dependency and Telegram configuration settings

### Summary
Added Telethon library dependency for Telegram integration. Updated config.py with new settings: TELEGRAM_API_ID, TELEGRAM_API_HASH, TELEGRAM_PHONE, and TELEGRAM_SESSION_NAME (defaults to 'frank_bot'). Updated .env.example with Telegram placeholders and .gitignore to ignore *.session files.

### Files Changed
- pyproject.toml (added telethon = "^1.34.0")
- poetry.lock (updated with telethon and dependencies)
- config.py (added telegram_* settings)
- .env.example (added Telegram configuration section)
- .gitignore (added *.session)

### Learnings
- Telethon uses session files (*.session) to store authentication state - these should be gitignored
- TELEGRAM_API_ID needs int conversion with a fallback (0 -> None pattern)
- Credentials come from my.telegram.org/apps, not Telegram bots API

---

## 2026-01-29: frank_bot-00015 - Create TelegramClientService with Telethon wrapper

### Summary
Created TelegramClientService in services/telegram_client.py following existing service patterns. Service wraps Telethon client with is_configured property, async connect/disconnect methods, and handles missing credentials gracefully with clear error messages.

### Files Changed
- services/telegram_client.py (new)

### Learnings
- Telethon client is async-native, so all service methods are async
- Authorization check (is_user_authorized) happens on connect, directing users to setup script if not authorized
- Service follows TelnyxSMSService pattern with similar structure

---

## 2026-01-29: frank_bot-00016 - Implement TelegramClientService message sending and retrieval methods

### Summary
Added core messaging methods to TelegramClientService: send_message(), get_messages(), get_dialogs(), and mark_read(). All methods return structured dataclass results (TelegramMessageResult, TelegramMessage, TelegramDialog) similar to SMSResult pattern. Includes error handling for rate limiting, recipient not found, and session invalidation.

### Files Changed
- services/telegram_client.py (methods added)

### Learnings
- Telethon's iter_messages() and iter_dialogs() are async generators - use async for
- FloodWaitError contains seconds to wait - useful info for user feedback
- Chat types detected via isinstance checks: User, Channel (broadcast/supergroup), Chat (group)
- Stats tracking follows existing pattern with get_service_stats()

---

## 2026-01-29: frank_bot-00017 - Create Telegram action handlers

### Summary
Created actions/telegram.py with three action handlers: send_telegram_message(), get_telegram_messages(), and list_telegram_chats(). Actions follow the standard signature pattern and return structured dicts with success status. Limit parameters are clamped to 1-100 range.

### Files Changed
- actions/telegram.py (new)
- tests/test_telegram_actions.py (new - 15 tests)

### Learnings
- Actions are thin wrappers around service methods, handling validation and result formatting
- Limit clamping (max(1, min(100, limit))) prevents abuse and invalid values
- Text preview truncation (100 chars + "...") provides summary without overwhelming response

---

## 2026-01-29: frank_bot-00018 - Add Telegram routes to server

### Summary
Added GET routes for /actions/telegram/send, /actions/telegram/messages, and /actions/telegram/chats to server/routes.py. Routes follow existing patterns with API key authentication and stats recording.

### Files Changed
- server/routes.py (imports and handlers added, routes added to list)

### Learnings
- All routes use GET method to minimize ChatGPT confirmation prompts
- Stats endpoint names follow camelCase convention (telegramSend, telegramMessages, telegramChats)
- Route handlers follow consistent pattern: auth check -> stats record -> payload -> responder

---

## 2026-01-29: frank_bot-00019 - Update OpenAPI spec with Telegram endpoints

### Summary
Added Telegram endpoints to openapi/spec.json: /actions/telegram/send, /actions/telegram/messages, and /actions/telegram/chats. Each endpoint includes query parameters, response schemas, and descriptions explaining the user account context (not a bot).

### Files Changed
- openapi/spec.json (paths and schemas added)

### Learnings
- Endpoint descriptions should clearly state that messages come from the user's personal account, not a bot
- Response schemas include nullable fields (text, sender_id) since Telegram messages can be media-only
- Chat type enum includes: user, group, supergroup, channel, unknown

---

## 2026-01-29: frank_bot-00020 - Create Telegram session setup script

### Summary
Created scripts/setup_telegram_session.py for interactive first-time Telegram authentication. Script prompts for credentials (or reads from environment), handles verification code and 2FA password input, and creates a .session file for persistent authentication. README updated with comprehensive Telegram setup instructions.

### Files Changed
- scripts/setup_telegram_session.py (new)
- README.md (Telegram integration section added)

### Learnings
- Telethon's send_code_request() triggers verification via the Telegram app (preferred) or SMS (fallback)
- Two-factor authentication requires a separate sign_in call with password parameter
- Session files should be mentioned as security-sensitive (provide account access without re-verification)
- getpass module provides secure password input that doesn't echo to terminal

---

## 2026-01-29: frank_bot-00021 - Add TelegramNamespace to FrankAPI for script execution

### Summary
Added TelegramNamespace class to meta/api.py with three methods: send(recipient, text), messages(chat, limit), and chats(limit). Updated FrankAPI to include telegram property. Updated introspection module to include TelegramNamespace in documentation. Created comprehensive unit tests.

### Files Changed
- meta/api.py (TelegramNamespace class and FrankAPI.telegram property added)
- meta/introspection.py (TelegramNamespace added to namespace list)
- tests/test_telegram_namespace.py (new - 11 tests)
- tests/conftest.py (new - mock telethon module for testing without dependency)

### Learnings
- The conftest.py mock for telethon allows tests to run without the library installed
- All namespace methods follow the same asyncio.run() pattern to wrap async actions
- Introspection module's namespace list controls what appears in generated documentation

---

## 2026-01-29: frank_bot-00022 - Update TelegramClientService to use DATA_DIR

### Summary
Updated TelegramClientService to construct session file path using DATA_DIR environment variable. Added _get_session_path() helper function that joins DATA_DIR (defaulting to ".") with session name. Session file path is now f"{data_dir}/{session_name}.session" instead of f"{session_name}.session".

### Files Changed
- services/telegram_client.py (added os import, _get_session_path helper, updated __init__ and connect)
- tests/test_telegram_client_service.py (new - 10 tests for session path logic)

### Learnings
- Use `os.getenv("VAR") or "."` instead of `os.getenv("VAR", ".")` to handle empty string case
- os.path.join("", "name") returns "name" not "./name"
- Session path needs to be stored before extension is added for Telethon client

---

## 2026-01-29: frank_bot-00023 - Add GET /telegram/status endpoint

### Summary
Added /telegram/status endpoint that returns Telegram connection status: 'not_configured' (missing env vars), 'needs_auth' (session not authorized), or 'connected' (with account info). Added is_authorized() and get_me() methods to TelegramClientService. Endpoint is public (no API key required) for web dashboard use.

### Files Changed
- services/telegram_client.py (added session_file_exists, is_authorized, get_me methods)
- actions/telegram.py (added get_telegram_status action)
- server/routes.py (added /telegram/status route)
- tests/test_telegram_actions.py (added 4 tests for status endpoint)

### Learnings
- Status endpoints should be public for dashboard pre-auth state checking
- Temporary TelegramClient can be created just for auth check without full connection
- get_me() returns User object with first_name, last_name, username, phone fields

---

## 2026-01-29: frank_bot-00024 - Add Stytch session validation middleware

### Summary
Created Stytch session validation middleware in server/stytch_middleware.py. StytchSessionValidator class calls Stytch API to verify session tokens. require_stytch_session decorator validates stytch_session_token cookie and returns 401 on failure. Added STYTCH_PROJECT_ID and STYTCH_SECRET to config.py.

### Files Changed
- config.py (added stytch_project_id and stytch_secret settings)
- server/stytch_middleware.py (new - StytchSessionValidator class and require_stytch_session decorator)
- tests/test_stytch_middleware.py (new - 9 tests for validator and middleware)

### Learnings
- Stytch test projects have project_id starting with "project-test-" and use test.stytch.com
- Session validation uses POST to /v1/sessions/authenticate with basic auth (project_id:secret)
- Decorator pattern works well for route protection - can be applied selectively

---

## 2026-01-29: frank_bot-00028 - Add GET /telegram/test endpoint

### Summary
Added /telegram/test endpoint that tests Telegram connection by fetching first 3 dialogs. Returns { connected: boolean, dialogs?: [...], error?: string }. Endpoint is public to allow testing from ChatGPT.

### Files Changed
- actions/telegram.py (added test_telegram_connection action)
- server/routes.py (added /telegram/test route)
- tests/test_telegram_actions.py (added 3 tests for test endpoint)

### Learnings
- Test endpoints should return meaningful data (dialogs) to verify full connectivity
- Limit=3 is sufficient for connection test without excessive data transfer
- Error message in response helps debugging connection issues

---

## 2026-01-29: frank_bot-00029 - Create web/ directory with Vite + TypeScript + Lit scaffold

### Summary
Created web dashboard scaffold with Vite 5.x + TypeScript 5.x + Lit 3.x. Dual build mode: SPA for dev (npm run build) and IIFE bundle for embedding (npm run build:lib). Directory structure: src/components/, src/lib/, src/styles/. API client with typed functions for all Frank Bot endpoints. CSS tokens with fallback values.

### Files Changed
- web/package.json (new - lit 3.1, vite 5.0, typescript 5.3)
- web/tsconfig.json (new - strict mode, decorators enabled)
- web/vite.config.ts (new - dual build mode, dev proxy to frank-bot:8000)
- web/index.html (new - dev preview page)
- web/src/frank-bot-embed.ts (new - main dashboard component)
- web/src/lib/api.ts (new - typed API client)
- web/src/styles/tokens.css (new - CSS custom properties)

### Learnings
- useDefineForClassFields: false is required for Lit decorators to work correctly
- IIFE format with inlineDynamicImports creates single bundle file for easy embedding
- CSS ?inline import in Vite allows embedding CSS in JS bundle
- Lit web components use Shadow DOM by default - styles are scoped

---

## 2026-01-29: frank_bot-00031 - Create web/nginx.conf with API proxy and static file serving

### Summary
Created nginx.conf for the web container with API proxy to frank-bot backend, /health endpoint for container health checks, CORS headers for bundle.js embedding, gzip compression, and static asset caching.

### Files Changed
- web/nginx.conf (new)

### Learnings
- nginx proxy_pass with trailing slash strips the location prefix (/api/ -> /)
- CORS headers (Access-Control-Allow-Origin *) needed for cross-origin embedding
- Cache-Control "immutable" prevents conditional requests for versioned assets

---

## 2026-01-29: frank_bot-00030 - Create web/Dockerfile with multi-stage build

### Summary
Created multi-stage Dockerfile with node:20-alpine builder stage for npm ci and npm run build:lib, and nginx:alpine production stage serving the bundle.js and index.html. Includes health check using wget.

### Files Changed
- web/Dockerfile (new)

### Learnings
- Multi-stage builds keep production image small (nginx:alpine ~20MB vs node:20-alpine ~180MB)
- wget is preferred over curl for health checks in alpine images
- HEALTHCHECK directive provides container-level health monitoring

---

## 2026-01-29: frank_bot-00025 - Add POST /telegram/auth/start endpoint

### Summary
Added /telegram/auth/start endpoint to start the Telegram authentication flow by sending a verification code. Returns phoneCodeHash needed for the verify step. Endpoint protected by Stytch session middleware.

### Files Changed
- services/telegram_client.py (added TelegramAuthResult dataclass, send_code_request method)
- actions/telegram.py (added start_telegram_auth action)
- server/routes.py (added telegram_auth_start_handler and route)
- tests/test_telegram_actions.py (added 4 tests)

### Learnings
- Telethon's send_code_request() returns SentCode object with phone_code_hash
- FloodWaitError contains retry delay in seconds - useful for user feedback
- Auth flow state (phone_code_hash) must be returned to client for next step

---

## 2026-01-29: frank_bot-00026 - Add POST /telegram/auth/verify endpoint

### Summary
Added /telegram/auth/verify endpoint to verify the Telegram verification code. Returns success, needs_2fa (if 2FA enabled), or invalid_code. Endpoint protected by Stytch session middleware.

### Files Changed
- services/telegram_client.py (added sign_in_with_code method, imported new Telethon errors)
- actions/telegram.py (added verify_telegram_code action)
- server/routes.py (added telegram_auth_verify_handler and route)
- tests/test_telegram_actions.py (added 5 tests)

### Learnings
- SessionPasswordNeededError is raised when 2FA is required - handle gracefully
- PhoneCodeInvalidError vs PhoneCodeExpiredError provide different user feedback
- The verify endpoint needs both code and phone_code_hash from the start step

---

## 2026-01-29: frank_bot-00027 - Add POST /telegram/auth/2fa endpoint

### Summary
Added /telegram/auth/2fa endpoint to complete Telegram authentication with 2FA password. Returns success or invalid_password. Endpoint protected by Stytch session middleware. Completes the web-based Telegram auth flow.

### Files Changed
- services/telegram_client.py (added sign_in_with_2fa method, imported PasswordHashInvalidError)
- actions/telegram.py (added verify_telegram_2fa action)
- server/routes.py (added telegram_auth_2fa_handler and route)
- tests/test_telegram_actions.py (added 4 tests)

### Learnings
- PasswordHashInvalidError is raised for incorrect 2FA password
- The 2FA endpoint only needs password - session state is maintained in .session file
- sign_in(password=) is a separate call from sign_in(phone=, code=, phone_code_hash=)

---

## 2026-01-29: frank_bot-00035 - Create Telegram card component (telegram-card.ts)

### Summary
Created telegram-card.ts Lit web component that fetches Telegram status and displays different states: not_configured (with env var guidance), needs_auth (with Connect button), and connected (with account info and Test Connection button).

### Files Changed
- web/src/components/telegram-card.ts (created)
- web/src/frank-bot-embed.ts (updated to import and use telegram-card)

### Learnings
- Lit web components use @customElement decorator for registration
- CSS custom properties from tokens.css enable theming and embedding
- Status badges provide visual feedback for different states

---

## 2026-01-29: frank_bot-00036 - Add Telegram auth wizard to telegram-card component

### Summary
Extended telegram-card.ts with a multi-step authentication wizard. The flow: click Connect Telegram -> send code -> enter verification code -> (optional) enter 2FA password -> connected. All states have proper loading indicators and error handling.

### Files Changed
- web/src/components/telegram-card.ts (extended with auth wizard)

### Learnings
- phoneCodeHash must be maintained in component state between steps
- Different error types (invalid_code, needs_2fa, invalid_password) require different UI feedback
- Auth wizard state management uses a discriminated union type (AuthWizardStep)

---

## 2026-01-29: frank_bot-00037 - Create scripts card component (scripts-card.ts)

### Summary
Created scripts-card.ts Lit web component that fetches and displays meta scripts. Features expandable script details with description, parameters, example code, and full source code. Includes refresh button and empty state.

### Files Changed
- web/src/components/scripts-card.ts (created)
- web/src/lib/api.ts (updated Script type to match backend, added getScriptCode function)
- web/src/frank-bot-embed.ts (updated to import and use scripts-card)

### Learnings
- Script code is fetched lazily when expanding a script (reduces initial load)
- Backend returns id, slug, description, parameters, example, created_at for scripts
- Code blocks with monospace font and pre-wrap handle source code display

---

## 2026-01-29: frank_bot-00038 - Create jobs card component (jobs-card.ts)

### Summary
Created jobs-card.ts Lit web component that fetches and displays job executions. Features status filter dropdown, auto-refresh toggle (5s interval), expandable job details with stdout/stderr/result/error, and color-coded status badges.

### Files Changed
- web/src/components/jobs-card.ts (created)
- web/src/lib/api.ts (updated Job types to match backend, added getJob function, added status parameter to getJobs)
- web/src/frank-bot-embed.ts (updated to import and use jobs-card)

### Learnings
- Auto-refresh uses setInterval with proper cleanup in disconnectedCallback
- Job details are fetched lazily when expanding (reduces initial load)
- Duration calculation handles both completed and running jobs

---

## 2026-01-29: frank_bot-00039 - Add CI/CD workflow for web container build and push

### Summary
Updated GitHub Actions workflow to build and push both the API and web containers. The web container builds from ./web/Dockerfile and pushes to ghcr.io/seanreardon/frank_bot-web:latest. Both jobs run in parallel.

### Status
BLOCKED: The workflow changes are prepared locally but cannot be pushed because the GitHub Personal Access Token lacks the `workflow` scope required to modify workflow files. The changes in .github/workflows/build_and_push.yml need to be pushed manually with a token that has the workflow scope.

### Files Changed
- .github/workflows/build_and_push.yml (added build-and-push-web job - not pushed)

### Learnings
- GitHub Actions jobs run in parallel by default (no dependency needed)
- Each job needs its own checkout, buildx setup, and registry login
- The -web suffix distinguishes the web container image from the API image
- Pushing workflow file changes requires a PAT with `workflow` scope

---

## 2026-01-30: frank_bot-00040 - Create SMSStorage service for file-based message persistence

### Summary
Created SMSStorage service in services/sms_storage.py with Pydantic models (SMSMessage, Contact, Attachment) matching schemas/sms.schema.json. Implements store_message() to write JSON files to ./data/sms/{localNumber}/ and get_recent_messages() for retrieval with filtering by local_number, remote_number, and contact_name. Messages sorted by timestamp descending.

### Files Changed
- services/sms_storage.py (new)
- tests/test_sms_storage.py (new - 25 tests)

### Learnings
- Pydantic BaseModel provides easy JSON serialization with model_dump(mode="json")
- Filename pattern uses - instead of : for filesystem safety (2026-01-29T18-45-32Z)
- Contact names sanitized by replacing <>:"/\|?* with underscores
- Plus sign (+) is valid in filenames and preserves phone number format

---

## 2026-01-30: frank_bot-00042 - Create ContactLookup service for phone-to-contact reverse lookup

### Summary
Created ContactLookup service in services/contact_lookup.py that searches Google Contacts for matching phone numbers. Implements phone normalization for comparison (strips spaces, dashes, handles +1 country code). Uses in-memory caching to prevent repeated API calls. Loads all contacts once then filters locally for efficiency.

### Files Changed
- services/contact_lookup.py (new)
- tests/test_contact_lookup.py (new - 28 tests)

### Learnings
- Phone matching needs to handle +1 country code differences (10 vs 11 digits)
- Loading all contacts once is more efficient than searching per lookup
- Cache stores both hits and misses to avoid repeated API calls
- GoogleContactsService.list_contacts() with pagination loads all contacts

---

## 2026-01-30: frank_bot-00043 - Create TelegramBot service for notification messages

### Summary
Created TelegramBot service in services/telegram_bot.py using Telegram Bot API (via httpx, not Telethon). Implements send_notification(), notify_unknown_sms(), and notify_spam() methods for SMS-related notifications. Added get_telegram_bot_credentials() to vault_client.py and TELEGRAM_BOT_TOKEN/TELEGRAM_BOT_CHAT_ID settings to config.py.

### Files Changed
- services/telegram_bot.py (new)
- services/vault_client.py (added get_telegram_bot_credentials)
- config.py (added telegram_bot_token and telegram_bot_chat_id settings)
- tests/test_telegram_bot.py (new - 23 tests)

### Learnings
- Telegram Bot API uses simple HTTP POST (no Telethon needed)
- Bot token format: {bot_id}:{secret} obtained from @BotFather
- HTML parse mode requires escaping &, <, > characters
- Notification messages should truncate long content (500 chars)

---

## 2026-01-30: frank_bot-00041 - Add MMS attachment download and storage to SMSStorage

### Summary
Extended SMSStorage with MMS attachment download capability. Added _download_attachment() async method using httpx, store_message_async() that downloads attachments before storing, and _generate_attachment_filename() for proper naming. Extension determined from MIME type with .bin fallback.

### Files Changed
- services/sms_storage.py (added httpx import, _generate_attachment_filename, _download_attachment, store_message_async)
- tests/test_sms_storage.py (added 11 tests for attachment functionality)

### Learnings
- mimetypes.guess_extension() returns extension with leading dot (.jpg)
- httpx.AsyncClient with timeout handles download failures gracefully
- Attachment filenames follow {timestamp}-{contact}-attachment-{n}.{ext} pattern
- Download failures don't prevent message storage - original attachment info preserved

---

## 2026-01-30: frank_bot-00044 - Create SMS webhook endpoint for inbound Telnyx messages

### Summary
Created SMS webhook handler in server/sms_webhook.py with sms_webhook_handler() async function. Parses Telnyx webhook payload, extracts message data, looks up sender contact, creates SMSMessage, and stores via SMSStorage. Added POST /webhook/sms route (no API key required - called by Telnyx).

### Files Changed
- server/sms_webhook.py (new)
- server/routes.py (added sms_webhook_handler import and /webhook/sms route)
- tests/test_sms_webhook.py (new - 13 tests)

### Learnings
- Telnyx webhook payload has nested structure: data.payload contains message details
- Direction field filters outbound confirmations and delivery receipts
- Contact lookup failures shouldn't fail webhook processing
- Classification set to 'unknown' for messages from unknown contacts

---

## 2026-01-30: frank_bot-00045 - Add STOP/HELP compliance handling for unknown contacts

### Summary
Created SMSComplianceService in services/sms_compliance.py for managing opt-outs/opt-ins. Added compliance keyword detection (STOP/HELP/START and variants). Updated sms_webhook_handler to check for compliance keywords ONLY when contact is None. Sends appropriate response SMS and stores message with classification='compliance'.

### Files Changed
- services/sms_compliance.py (new)
- server/sms_webhook.py (added compliance handling)
- tests/test_sms_compliance.py (new - 19 tests)
- tests/test_sms_webhook.py (added 4 compliance tests)

### Learnings
- Standard compliance keywords: STOP, STOPALL, UNSUBSCRIBE, CANCEL, END, QUIT (opt-out); HELP, INFO (help); START, YES, OPTIN, SUBSCRIBE, UNSTOP (opt-in)
- Compliance messages stored with classification='compliance' and processed=True
- Known contacts bypass all compliance handling

---

## 2026-01-30: frank_bot-00046 - Add Telegram Bot notifications for unknown SMS senders

### Summary
Extended sms_webhook_handler to send Telegram notifications for unknown senders (non-compliance messages). Added _send_unknown_sender_notification() helper function that uses TelegramBot.notify_unknown_sms(). Failures are logged but don't fail webhook processing.

### Files Changed
- server/sms_webhook.py (added TelegramBot import and notification handling)
- tests/test_sms_webhook.py (added 5 Telegram notification tests)

### Learnings
- Telegram notifications only sent when contact is None AND message is not compliance-related
- Notification includes: from_number, message preview, attachment_count
- telegram_notified flag added to response when notification succeeds

---

## 2026-01-30: frank_bot-00047 - Update outbound SMS to also store messages

### Summary
Extended TelnyxSMSService.send_sms() to store outbound messages after successful send. Added _store_outbound_message() method that creates SMSMessage with direction='outbound', processed=True, and stores via SMSStorage. Contact lookup performed to resolve recipient to contact info.

### Files Changed
- services/telnyx_sms.py (added _store_outbound_message method, lazy imports)
- tests/test_telnyx_sms.py (new - 6 tests)

### Learnings
- Outbound messages marked processed=True (already "processed")
- Storage failures logged but don't fail the SMS send
- Contact lookup failures don't prevent storage (contact set to None)
- Lazy imports to avoid circular dependencies

---

## 2026-01-30: frank_bot-00048 - Add ChatGPT action and route for reading SMS messages

### Summary
Added get_sms_messages_action() to actions/sms.py for retrieving SMS history. Accepts limit, contact, phone, and direction parameters. Added GET /actions/sms/messages route. Updated OpenAPI spec with endpoint and response schema.

### Files Changed
- actions/sms.py (added get_sms_messages_action)
- server/routes.py (added route and handler)
- openapi/spec.json (added /actions/sms/messages endpoint and schemas)
- tests/test_sms_messages_action.py (new - 10 tests)

### Learnings
- Response format: count + messages array with timestamp, direction, contact, phone, preview, hasAttachments, jorbId
- Direction filter applied after fetching (fetches 2x limit when filtering)
- Preview truncated at 100 chars with "..." suffix
- Contact name returned only when available

---

## 2026-01-30: frank_bot-00049 - Create web dashboard Telegram Bot status card

### Summary
Added GET /telegram-bot/status and POST /telegram-bot/test endpoints to server/routes.py. Created actions/telegram_bot.py with get_telegram_bot_status() and test_telegram_bot() action handlers. Created telegram-bot-card.ts Lit component that displays configuration status and allows testing the bot connection.

### Files Changed
- actions/telegram_bot.py (new)
- server/routes.py (added telegram-bot routes)
- web/src/lib/api.ts (added TelegramBotStatus, testTelegramBot)
- web/src/components/telegram-bot-card.ts (new)
- web/src/frank-bot-embed.ts (imported telegram-bot-card)
- tests/test_telegram_bot_actions.py (new - 7 tests)

### Learnings
- GET /telegram-bot/status is public (no auth) for dashboard access
- POST /telegram-bot/test protected by Stytch session (sends real message)
- Card uses blue left accent border to distinguish from Telegram client card

---

## 2026-01-30: frank_bot-00050 - Add SMS messages card to web dashboard

### Summary
Extended web/src/lib/api.ts with getSmsMessages() function and types. Created sms-card.ts Lit component that displays SMS messages grouped by conversation (remote phone number). Shows contact name if known, direction-based styling (outbound=right-aligned gold, inbound=left-aligned border), attachment indicator, timestamp formatting, and filter input with debounce.

### Files Changed
- web/src/lib/api.ts (added SmsMessage, SmsMessagesResponse, getSmsMessages)
- web/src/components/sms-card.ts (new)
- web/src/frank-bot-embed.ts (imported sms-card)
- web/src/vite-env.d.ts (new - TypeScript declarations for Vite CSS imports)

### Learnings
- Conversations grouped by phone number using Map
- Filter input detects phone numbers (+ and digits) vs contact names
- Debounce set to 300ms for filter input
- Attachment indicator uses SVG paperclip icon
- Green left border accent for SMS card

---

## 2026-01-30: frank_bot-00073 - Add schemas/jorb.schema.json for jorb data validation

### Summary
Extended the existing jorb.schema.json with a JorbMessage schema definition in the $defs section. The Jorb schema was already present with all required fields (id, name, status, plan, createdAt) and optional fields (contacts, progressSummary, pausedReason, needsApprovalFor, awaiting).

### Files Changed
- schemas/jorb.schema.json (added $defs/JorbMessage schema)

### Learnings
- Schema already existed with comprehensive Jorb definition
- JorbMessage schema added with: id, jorbId, timestamp, direction, channel, sender, senderName, recipient, content, agentReasoning
- Uses camelCase for JSON serialization, snake_case for Python dataclasses

---

## 2026-01-30: frank_bot-00051 - Create jorb_storage.py with SQLite persistence for jorbs and messages

### Summary
Created JorbStorage service using aiosqlite for async SQLite persistence. Implements full CRUD operations for jorbs with status tracking, plus message and checkpoint storage. Dataclasses match the schema definition.

### Files Changed
- services/jorb_storage.py (new - JorbStorage class)
- pyproject.toml (added aiosqlite dependency)
- tests/test_jorb_storage.py (new - 19 tests)

### Learnings
- aiosqlite connections should be created fresh per operation with `async with aiosqlite.connect()`
- Can't use `async with await connection()` pattern - creates threading issues
- Schema initialization done once per storage instance with _initialized flag
- JorbContact dataclass with to_dict/from_dict for JSON serialization
- Jorb.contacts property handles JSON<->list conversion transparently

---

## 2026-01-30: frank_bot-00052 - Add message tracking methods to JorbStorage

### Summary
Message tracking methods were implemented as part of frank_bot-00051 in the same service file. Includes add_message, get_messages, get_open_jorbs_with_messages, and checkpoint methods.

### Files Changed
- services/jorb_storage.py (already includes message methods)
- tests/test_jorb_storage.py (includes message tests)

### Learnings
- Implemented together with 00051 since they're in the same service
- get_open_jorbs_with_messages filters to running/paused only (not planning)
- Messages sorted by timestamp ascending (oldest first) for conversation view
- JorbWithMessages dataclass bundles jorb with its message history

---

## 2026-01-30: frank_bot-00069 - Add jorb environment variables to config and documentation

### Summary
Added all jorb-related settings to config.py Settings dataclass and get_settings() function. Updated .env.example with commented examples. Added Jorbs section to README.md documenting all environment variables and endpoints.

### Files Changed
- config.py (added 12 new settings for jorbs, SMTP, debouncing)
- .env.example (added jorbs configuration section)
- README.md (added Jorbs documentation section)

### Learnings
- Settings include: OPENAI_API_KEY, JORBS_DB_PATH, JORBS_PROGRESS_LOG
- Policy settings: AGENT_SPEND_LIMIT ($100 default), CONTEXT_RESET_DAYS (3 default)
- Debounce settings: DEBOUNCE_TELEGRAM_SECONDS (60), DEBOUNCE_SMS_SECONDS (30)
- SMTP settings for daily digest emails
- Documented gpt-5.2 model as hardcoded (not configurable)

---

## 2026-01-30: frank_bot-00061 - Implement message debouncing for incoming messages

### Summary
Created MessageBuffer service that collects messages from the same sender/channel and combines them after a configurable debounce window. Uses asyncio timers for automatic flushing.

### Files Changed
- services/message_buffer.py (new - MessageBuffer class)
- tests/test_message_buffer.py (new - 17 tests)

### Learnings
- BufferEntry tracks messages list and timer task per sender/channel
- buffer_message() returns True for first message (starts timer), False for subsequent
- flush_buffer() cancels timer and immediately returns combined event
- BufferedEvent includes message_count for downstream processing
- Messages combined with newlines for natural conversation flow
- Timer tests use 1-second debounce for fast execution

---

## 2026-01-30: frank_bot-00053 - Create agent_runner.py with OpenAI wrapper and context building

### Summary
Created AgentRunner service with OpenAI gpt-5.2 integration for jorb processing. Includes context building matching agent_system.md format, response parsing, and message storage helpers.

### Files Changed
- services/agent_runner.py (new - AgentRunner class)
- tests/test_agent_runner.py (new - 45 tests)
- pyproject.toml (added openai dependency)

### Learnings
- Model gpt-5.2 is hardcoded as specified in PRD
- build_context() formats event and open jorbs for LLM consumption
- parse_agent_response() extracts jorb_id, reasoning, action, task_update from JSON
- AgentAction dataclass with type, channel, recipient, content, pause_reason, needs_approval_for
- Tests skip OpenAI-dependent tests when package not installed

---

## 2026-01-30: frank_bot-00054 - Implement process_incoming_message in AgentRunner

### Summary
Added process_incoming_message method that handles incoming SMS/Telegram messages end-to-end. Enriches events with contact lookup, calls gpt-5.2, stores messages, and executes actions.

### Files Changed
- services/agent_runner.py (added process_incoming_message, _send_message, _enrich_event_with_contact)
- tests/test_agent_runner.py (added TestProcessIncomingMessage, TestContactEnrichment, TestSendMessage)

### Learnings
- ProcessingResult dataclass tracks jorb_id, action_taken, success, message_sent
- Contact enrichment only applies to SMS (phone numbers), not Telegram usernames
- _send_message dispatches to TelnyxSMSService or TelegramClientService based on channel
- Email channel returns False pending frank_bot-00066 implementation

---

## 2026-01-30: frank_bot-00055 - Implement jorb kickoff flow in AgentRunner

### Summary
Added kickoff_jorb method that sends the initial message for new jorbs. Builds context with jorb_created event type, calls gpt-5.2, executes the first action, and updates status to running.

### Files Changed
- services/agent_runner.py (added kickoff_jorb, updated build_context for kickoff)
- tests/test_agent_runner.py (added TestKickoffJorb)

### Learnings
- KickoffResult dataclass tracks jorb_id, success, action_taken, message_sent
- build_context extended with kickoff_jorb parameter for new jorb context
- Agent may decide no initial action (passive monitoring tasks) or pause immediately
- Jorb status transitions from planning to running after kickoff

---

## 2026-01-30: frank_bot-00056 - Create actions/jorbs.py with jorb CRUD actions

### Summary
Created jorb CRUD action handlers following the existing action pattern. Supports creating jorbs with contacts, listing with status filter, getting full details with messages, and message pagination.

### Files Changed
- actions/jorbs.py (new - create_jorb_action, list_jorbs_action, get_jorb_action, get_jorb_messages_action)
- tests/test_jorbs_actions.py (new - 23 tests)

### Learnings
- Contacts can be passed as JSON string or list of dicts
- start_immediately=True (default) triggers kickoff_jorb via AgentRunner
- list_jorbs_action defaults to "open" status filter
- get_jorb_action supports include_messages parameter for optional message history
- get_jorb_messages_action supports limit and offset for pagination

---

## 2026-01-30: frank_bot-00066 - Create email_service.py for notifications and digest

### Summary
Created EmailService for sending notifications via SMTP. Supports HTML and plain text emails, with specific methods for jorb pause and completion notifications.

### Files Changed
- services/email_service.py (new - EmailService class)
- tests/test_email_service.py (new - 17 tests)
- pyproject.toml (added aiosmtplib dependency)

### Learnings
- Uses aiosmtplib for async SMTP with STARTTLS
- notify_jorb_paused sends email when jorb needs approval
- notify_jorb_complete sends completion notification
- DIGEST_EMAIL_TO setting provides default recipient
- Graceful failure handling - SMTP errors logged but don't crash

---

## 2026-01-30: frank_bot-00057 - Add approve and cancel actions for jorbs

### Summary
Added approve_jorb_action and cancel_jorb_action to complete jorb lifecycle management. Approve transitions paused jorbs to running and triggers agent kickoff. Cancel prevents further processing of active jorbs.

### Files Changed
- actions/jorbs.py (added approve_jorb_action, cancel_jorb_action)
- tests/test_jorbs_actions.py (added TestApproveJorbAction, TestCancelJorbAction - 13 tests)

### Learnings
- Approval records decision in progress_summary and triggers agent kickoff
- Cancel validates jorb isn't already complete/cancelled
- Both actions clear paused_reason and needs_approval_for fields
- Agent kickoff after approval allows immediate action on new decision

---

## 2026-01-30: frank_bot-00058 - Implement brief_me action for jorb status briefing

### Summary
Added brief_me_action for ChatGPT to quickly catch up on jorb status. Returns needs_attention count, activity per jorb, highlights, and pending decisions. Tracks last briefing timestamp in persistent state file.

### Files Changed
- actions/jorbs.py (added brief_me_action, _get_last_briefing_timestamp, _save_last_briefing_timestamp, _format_jorb_activity)
- tests/test_jorbs_actions.py (added TestBriefMeAction - 8 tests)

### Learnings
- Briefing state stored in data/briefing_state.json
- hours parameter filters activity window (default 24 hours)
- update_timestamp parameter controls whether to advance briefing time
- Long messages truncated to 100 chars in activity summary

---

## 2026-01-30: frank_bot-00059 - Add jorb routes to server

### Summary
Added all jorb HTTP routes to server/routes.py following existing patterns. All routes protected by API key and use GET method for ChatGPT compatibility.

### Files Changed
- server/routes.py (added jorbs imports and 7 route handlers)
- tests/test_jorb_routes.py (new - 11 integration tests)

### Learnings
- Path parameters extracted via request.path_params["id"]
- Route order matters: /jorbs/brief must come before /jorbs/{id}
- All routes use _build_responder wrapper for consistent error handling

---

## 2026-01-30: frank_bot-00060 - Update OpenAPI spec with jorb endpoints

### Summary
Added all jorb endpoints and schemas to openapi/spec.json. Includes full documentation for ChatGPT integration with jorb lifecycle.

### Files Changed
- openapi/spec.json (added 8 jorb paths, 12 jorb schemas)

### Learnings
- JorbContact, JorbMessage, JorbSummary as reusable schema components
- BriefMeResponse includes nested JorbActivitySummary and PendingDecision schemas
- Spec passes linting (only pre-existing warnings about 4xx responses)

---

## 2026-01-30: frank_bot-00064 - Implement JorbPolicy enforcement in AgentRunner

### Summary
Added JorbPolicy dataclass and enforcement to AgentRunner. Rate limiting tracks messages per hour per jorb, auto-pauses stale jorbs, auto-fails expired jorbs, and records policy violations for briefing.

### Files Changed
- services/agent_runner.py (added JorbPolicy, PolicyViolation, rate limit methods, stale/expired checks)
- tests/test_agent_runner.py (added TestJorbPolicy, TestPolicyEnforcement - 13 tests)

### Learnings
- Rate limit uses in-memory dict with timestamp list per jorb
- Stale check compares updated_at against stale_jorb_hours
- Expired check compares created_at against max_jorb_duration_days
- Policy violations stored for inclusion in brief_me output
- Environment variables: AGENT_MAX_MESSAGES_PER_HOUR, AGENT_STALE_JORB_HOURS, AGENT_MAX_JORB_DURATION_DAYS

---

---

## 2026-01-30: frank_bot-00062 - Connect SMS webhook to jorb message processing

### Summary
Extended the SMS webhook handler to route messages from known contacts and jorb participants through the MessageBuffer for debouncing, then to AgentRunner for processing. Added helper functions to check if a phone number belongs to any active jorb's contacts.

### Files Changed
- server/sms_webhook.py (extended with jorb routing)
- tests/test_sms_webhook.py (added TestSmsWebhookJorbRouting, TestSmsJorbContactCheck)

### Learnings
- SMS webhook already had contact lookup; extended to also check jorb participant status
- Message buffering callback triggers agent processing after debounce period
- Known contacts bypass Telegram notification since they're routed to jorb processing

---

## 2026-01-30: frank_bot-00063 - Connect Telegram messages to jorb message processing

### Summary
Extended TelegramClientService with on_message callback registration using Telethon events. Created telegram_jorb_router.py service to handle message routing through MessageBuffer to AgentRunner. Only processes messages from mutual contacts who are in active jorb contact lists.

### Files Changed
- services/telegram_client.py (added register_message_handler, start_listening, stop_listening)
- services/telegram_jorb_router.py (new - handles Telegram  debounce  agent flow)
- tests/test_telegram_jorb_router.py (new - 16 tests)

### Learnings
- Telethon's events.NewMessage works well for real-time message capture
- Module-level handlers list with dispatcher pattern allows multiple registrations
- Contact matching uses username (case-insensitive) or name for Telegram (not phone)

---

## 2026-01-30: frank_bot-00067 - Implement daily digest email for jorbs

### Summary
Added send_daily_digest method to EmailService with comprehensive HTML and plain text digest formatting. Digest includes active/paused/completed jorbs, message counts by channel, key agent reasoning, and costs. Added DIGEST_TIME environment variable for scheduling.

### Files Changed
- services/email_service.py (added send_daily_digest, JorbCosts, JorbDigestSummary, DailyDigestData)
- tests/test_email_service.py (added TestBuildJorbSummary, TestSendDailyDigest, TestDigestTime)

### Learnings
- HTML email with inline styles works best for email client compatibility
- Key decisions extracted from agent_reasoning field on outbound messages
- Paused jorbs trigger different subject line to highlight need for attention

---

## 2026-01-30: frank_bot-00065 - Implement context reset (Ralph Loop) mechanism

### Summary
Created ContextResetService for periodic context compression in long-running jorbs. Tracks reset state, generates LLM handoff summaries, maintains progress log in Claudia-inspired markdown format, and updates jorb progress summaries.

### Files Changed
- services/context_reset.py (new - ContextResetService, ContextResetState, HandoffSummary, JorbHandoff)
- tests/test_context_reset.py (new - 16 tests)

### Learnings
- CONTEXT_RESET_DAYS default of 3 balances context freshness with overhead
- Progress log uses markdown format for human readability
- build_fresh_context() provides complete restart context including last 100 lines of progress log

---

## 2026-01-30: frank_bot-00068 - Create background event loop for jorb system

### Summary
Created BackgroundLoopService with Starlette lifecycle integration. Manages Telegram message listening, hourly heartbeat for stale/expired jorb detection, daily digest scheduling, and graceful shutdown handling. All background tasks are fault-tolerant with error logging.

### Files Changed
- services/background_loop.py (new - BackgroundLoopService, start/stop functions)
- server/app.py (added lifecycle events to start/stop background loop)
- tests/test_background_loop.py (new - 20 tests)

### Learnings
- asyncio.Event with wait_for timeout allows clean shutdown signaling
- Signal handlers need try/except for Windows/non-main-thread compatibility
- Module-level singleton pattern works well for service lifecycle management

---

## 2026-01-30: frank_bot-00070 - Create web dashboard jorbs card component

### Summary
Extended web/src/lib/api.ts with jorb API functions and types. Created jorbs-card.ts Lit component with status filtering, auto-refresh, expandable details, and approve/cancel actions for paused jorbs. Status badges use color-coded styling.

### Files Changed
- web/src/lib/api.ts (added Jorb types and API functions)
- web/src/components/jorbs-card.ts (new - JorbsCard Lit component)
- web/src/frank-bot-embed.ts (added jorbs-card import and usage)

### Learnings
- Lit state updates work well with Map/Set using spread operator for immutability
- Status badge styling needs inline styles for dynamic colors
- Event bubbling with composed: true needed for cross-shadow-DOM communication

---

## 2026-01-30: frank_bot-00071 - Add jorb message thread view to web dashboard

### Summary
Created jorb-thread-view.ts component for detailed conversation history. Features message grouping by date, inbound/outbound styling, collapsible agent reasoning, auto-scroll, and pagination support. Dashboard switches between jorbs-card and thread view on selection.

### Files Changed
- web/src/components/jorb-thread-view.ts (new - JorbThreadView Lit component)
- web/src/frank-bot-embed.ts (added thread view routing and state)

### Learnings
- requestAnimationFrame needed for reliable scroll-to-bottom after render
- Date grouping with Map preserves insertion order for chronological display
- Channel icons using emoji work well cross-platform

---

## 2026-01-30: frank_bot-00072 - Write integration tests for jorb end-to-end flow

### Summary
Created comprehensive integration test suite covering jorb lifecycle, pause/approve/cancel workflows, message debouncing, context reset, and brief_me summary. Tests use mocked OpenAI, Telegram, and SMS services.

### Files Changed
- tests/test_jorb_integration.py (new - 13 test cases)

### Learnings
- Tests with skipif for optional dependencies keep test suite runnable
- Actions create their own storage instances, so integration tests may need mocking
- MessageBuffer debounce times need adjustment for test reliability

---
