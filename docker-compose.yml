# frank_bot docker-compose
# just some silly text to provoke a rebuild
#
# CI/CD: GitHub Actions builds and pushes images to GHCR on merge to main.
#        See .github/workflows/build_and_push.yml
#
# Production deployment:
#   docker compose pull
#   docker compose up -d
#
# Local development (build from source):
#   docker compose up -d --build
#
# Note: The 'build' directive exists for local dev convenience only.
# Production should always pull pre-built images from GHCR - never build on the server.

services:
  # ==========================================================================
  # Core Service
  # ==========================================================================
  # services:
  frank-bot:
    image: ghcr.io/seanreardon/frank_bot:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: frank-bot
    restart: unless-stopped
    dns:
      - 1.1.1.1
      - 8.8.8.8
      - 10.0.0.1
    ports:
      - "127.0.0.1:8000:8000"
    env_file:
      - .env
    environment:
      # Container-specific settings (not from .env)
      LOG_LEVEL: "INFO"
      DEFAULT_TIMEZONE: "America/Chicago"

      # Container paths for Google credentials
      GOOGLE_TOKEN_FILE: "/app/secrets/token.json"
      GOOGLE_CREDENTIALS_FILE: "/app/secrets/google-credentials.json"

      # Container path for logs
      LOG_FILE: "/app/logs/frank_bot-api.log"

      # Container path for data (scripts and jobs)
      DATA_DIR: "/app/data"

      # Optional manifest metadata (defaults if not in .env)
      ACTIONS_NAME_FOR_HUMAN: "${ACTIONS_NAME_FOR_HUMAN:-Frank Bot}"
      ACTIONS_NAME_FOR_MODEL: "${ACTIONS_NAME_FOR_MODEL:-frank_bot}"
      ACTIONS_LOGO_URL: "${ACTIONS_LOGO_URL:-}"
      ACTIONS_CONTACT_EMAIL: "${ACTIONS_CONTACT_EMAIL:-}"
      ACTIONS_LEGAL_URL: "${ACTIONS_LEGAL_URL:-}"

      # Version (default if not in .env)
      APP_VERSION: "${APP_VERSION:-0.3.0}"
    volumes:
      # Mount Google credentials (read-only for security)
      - ./google-credentials.json:/app/secrets/google-credentials.json:ro
      # Mount OAuth token (read-write so it can be refreshed)
      - ./token.json:/app/secrets/token.json
      # Persist logs
      - ${LOG_PATH:-./logs}:/app/logs
      # Persist scripts and jobs data
      - ./data:/app/data
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - frank-bot

networks:
  frank-bot:
    driver: bridge
