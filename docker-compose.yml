# frank_bot docker-compose
# just some silly text to provoke a rebuild
#
# CI/CD: GitHub Actions builds and pushes images to GHCR on merge to main.
#        See .github/workflows/build_and_push.yml
#
# Production deployment:
#   docker compose pull
#   docker compose up -d
#
# Local development (build from source):
#   docker compose up -d --build
#
# Note: The 'build' directive exists for local dev convenience only.
# Production should always pull pre-built images from GHCR - never build on the server.

services:
  # ==========================================================================
  # Core Service
  # ==========================================================================
  # services:
  frank-bot:
    image: ghcr.io/seanreardon/frank_bot:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: frank-bot
    restart: unless-stopped
    dns:
      - 1.1.1.1
      - 8.8.8.8
      - 10.0.0.1
    ports:
      - "127.0.0.1:8000:8000"
    environment:
      # Vault connection (AppRole). These are the only "secret-ish" env vars
      # we expect to come from `.env` / host environment.
      VAULT_ADDR: "${VAULT_ADDR:-}"
      VAULT_ROLE_ID: "${VAULT_ROLE_ID:-}"
      VAULT_SECRET_ID: "${VAULT_SECRET_ID:-}"

      # Public origin used in manifests + OpenAPI servers[]
      PUBLIC_BASE_URL: "${PUBLIC_BASE_URL:-http://localhost:8000}"

      # Container-specific settings (not from .env)
      LOG_LEVEL: "INFO"
      DEFAULT_TIMEZONE: "America/Chicago"

      # Container paths for Google credentials
      GOOGLE_TOKEN_FILE: "/app/secrets/token.json"
      GOOGLE_CREDENTIALS_FILE: "/app/secrets/google-credentials.json"

      # Container path for logs
      LOG_FILE: "/app/logs/frank_bot-api.log"

      # Container path for data (scripts and jobs)
      DATA_DIR: "/app/data"

      # Android phone ADB targeting
      # - USB (preferred): set ANDROID_DEVICE_SERIAL (e.g. from `adb devices`)
      # - TCP/IP (fallback): set ANDROID_ADB_HOST/ANDROID_ADB_PORT (wireless debugging)
      ANDROID_DEVICE_SERIAL: "${ANDROID_DEVICE_SERIAL:-}"
      ANDROID_ADB_HOST: "${ANDROID_ADB_HOST:-}"
      ANDROID_ADB_PORT: "${ANDROID_ADB_PORT:-}"

      # Optional manifest metadata (defaults if not in .env)
      ACTIONS_NAME_FOR_HUMAN: "${ACTIONS_NAME_FOR_HUMAN:-Frank Bot}"
      ACTIONS_NAME_FOR_MODEL: "${ACTIONS_NAME_FOR_MODEL:-frank_bot}"
      ACTIONS_LOGO_URL: "${ACTIONS_LOGO_URL:-}"
      ACTIONS_CONTACT_EMAIL: "${ACTIONS_CONTACT_EMAIL:-}"
      ACTIONS_LEGAL_URL: "${ACTIONS_LEGAL_URL:-}"

      # Version (default if not in .env)
      APP_VERSION: "${APP_VERSION:-0.3.0}"
    # gnirehtet reverse tether requires a TUN device + NET_ADMIN.
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      # USB passthrough for Android phone (ADB over USB).
      #
      # Use a bind mount (not `devices:`) so USB bus re-enumeration doesn't leave
      # the container with a stale /dev/bus/usb snapshot (e.g. device 009â†’010).
      - /dev/bus/usb:/dev/bus/usb
      # Mount Google credentials (read-only for security)
      - ./google-credentials.json:/app/secrets/google-credentials.json:ro
      # Mount OAuth token (read-write so it can be refreshed)
      - ./token.json:/app/secrets/token.json
      # Persist logs
      - ${LOG_PATH:-./logs}:/app/logs
      # Persist scripts and jobs data
      - ./data:/app/data
      # Persist ADB keys (so Android phone stays authorized across rebuilds)
      - ./adb-keys:/root/.android
    # Allow access to newly-enumerated USB device nodes under /dev/bus/usb.
    device_cgroup_rules:
      - "c 189:* rwm"
    sysctls:
      net.ipv4.ip_forward: "1"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - frank-bot
      - concordia  # Access to Vault (concordia-vault:8200)

  # ==========================================================================
  # Web Dashboard
  # ==========================================================================
  frank-bot-web:
    image: ghcr.io/seanreardon/frank_bot-web:latest
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: frank-bot-web
    restart: unless-stopped
    ports:
      - "127.0.0.1:8002:80"
    volumes:
      # Share data directory with API (for Telegram session, etc.)
      - ./data:/app/data
    networks:
      - frank-bot
    depends_on:
      - frank-bot

networks:
  frank-bot:
    driver: bridge
  concordia:
    external: true  # Shared network for Vault access
